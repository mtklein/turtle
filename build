#!/usr/bin/env python3

import os
import sys

srcs = ['hash']
modes = {
    'dbg': '',
    'opt': '-Os',
    'lto': '-Os -flto',
    'san': '-fsanitize=address,integer,undefined -fno-sanitize-recover=all',
}

with open('build.ninja', 'w') as f:
    f.write('''
builddir = out

cc = clang -fcolor-diagnostics -Weverything -Xclang -nostdsysteminc

rule compile
    command = $cc -g -Werror -MD -MF $out.d -c $in -o $out
    depfile = $out.d
    deps    = gcc

rule link
    command = $cc $in -o $out

rule run
    command = ./$in > $out
''')

    for src in srcs:
        for mode,flags in modes.items():
            f.write(f'''
build out/{mode}/{src}.o:      compile {src}.c
  cc = $cc {flags}
build out/{mode}/{src}_test.o: compile {src}_test.c
  cc = $cc {flags}
build out/{mode}/{src}_test:   link out/{mode}/{src}.o out/{mode}/{src}_test.o
  cc = $cc {flags}
build out/{mode}/{src}.ok:     run out/{mode}/{src}_test
''')


if os.system('ninja ' + ' '.join(sys.argv[1:])) == 0:
    os.remove('build.ninja')
    sys.exit(os.system('git add -u'))
sys.exit(1)
